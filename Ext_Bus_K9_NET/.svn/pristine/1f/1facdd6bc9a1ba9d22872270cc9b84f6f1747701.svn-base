/////////////////////////////////////////////////////////下拉框提示/////////////////////////////////////////////////////////////////////////////
var textId //用于判定是哪个提示框 
 function busstopquery(value,cityname,num ,id) {
    textId = id ;
    if( value!="" )	{
	  var dataurl = "Maps.ashx?";
	  if(num==1||num==2) //公交地铁
           data = "_method=busstopquery"+"&stopvalue="+escape(value.trim())+"&cityname="+escape(cityname.trim());
      else if(num ==3||num ==4)  //驾车路线
           data = "_method=SelfCarQuery"+"&stopvalue="+escape(value.trim())+"&cityname="+escape(cityname.trim());
      else
           data = "_method=SelfCarQuery"+"&stopvalue="+escape(value.trim())+"&cityname="+escape(cityname.trim());
      AJAXRequest(dataurl,true,"POST",data,AiTip_CallBack);
	}
 }
//下拉框提示回调函数
function AiTip_CallBack(response){
    if (response == null || response == "") {
         return;
    }
    clearSuggest();
    var resArr = response.split("$");
    for( var i = 0 ;i <resArr.length ; i++){
        createSuggest(resArr[i]) ;
    }
    displaySuggest() ;
}
//创建下拉框选项
function createSuggest(text) {
    var sDiv = "<div class = 'out' onmouseover = \"this.className ='over'\""
            +"onmouseout = \"this.className = 'out'\" onclick ='setSuggest(this)'>"+text+"</div>" ;
    $("suggest").innerHTML += sDiv ;
}
//点击获取下拉框的值 
function setSuggest(src)
{
    $(textId).value = src.innerHTML ;
    hiddenSuggest() ;
}
//显示下拉框
function displaySuggest(){
    $("suggest").style.display = "" ;
    var temp = GetAbsolutePos($(textId)) ;
    $("suggest").style.left =temp[0] +"px" ;
    $("suggest").style.top =temp[1] +parseInt($(textId).offsetHeight) +"px";
    $("suggest").style.width = $(textId).offsetWidth +"px";
}
//隐藏下拉框
function hiddenSuggest(){
 if($("suggest")!=null)
    $("suggest").style.display = "none"
}
//清空下拉框 ;
function clearSuggest(){
    $("suggest").innerHTML = "" ;
}
//////////////////////////////////////////////////////////////////////////关键字搜索///////////////////////////////////////////////////////////////
function SearchByWords(){
	var key = $("keyword").value;
    if(key.trim() == "")    {
//        ShowAlertDiv("提示","请输入关键字！");
        alert("请输入关键字！");
        return;
    }
    var dataurl =  "Maps.ashx?";
    var data = "_method=QueryByWords"+"&key="+escape(key.trim());
    AJAXRequest(dataurl,true,"POST",data,cbQuery);
     loadBar(1);
}

///////////////////////////////////////////////////////////////////////路径分析////////////////////////////////////////////////////////////////////////////
var startStop ; //起点 ;
var endStop; //终点
var mulRes = new Array();  
var matcheList;  
var curPage = 0; 
var maxperpage = 12; 
var keyConst = 32; 
var iroute=-1;//公交线路标识，当一条线路在运行时另外几条不响应
var car;
//计算两点所组成的线段与Y轴方向的夹角
function computeAngle(startX,startY,endX,endY)
{	
	var slopeX = endX-startX;
	var slopeY = endY-startY;
	var K = slopeX/slopeY;
	var angle = parseInt(Math.atan(K)*180/Math.PI);
	if(endX>startX && endY>startY)
		return angle;
	else if(endX>startX && endY<startY)
		return 180+angle;
	else if(endX<startX && endY<startY)
		return angle+180;
	else if(endX<startX && endY>startY)
		return 360+angle;
	else if(endX>startX && endY==startY)
		return 90;
	else if(endX==startX && endY<startY)
		return 180;
	else if(endX<startX && endY==startY)
		return 270;
	else if(endX==startX && endY>startY)
		return 0;
} 
//路径分析（搜索路径）
function SearchPath(SearchFlg){
    var start = $("ns1").value
    var end = $("ns2").value
    var startCity = "C027|武汉道路网";
	var endCity = "C027|武汉道路网";
	startStop = start.trim() ;
	endStop = end.trim();
	var px = 0.1;
    if(start=="")
		alert("起点名称没填！");
	else if(end=="")
		alert("终点名称没填！");
	else if(thisObj.isCarMove)
         alert("小车正在运行状态，请先停止小车移动");	
	else {
		var dataurl = "Maps.ashx?";
		var data = "_method=GetDriveWay"+"&px="+escape(px)+"&sta="+escape(startStop)+"&end="+escape(endStop)+"&startCity="+escape(startCity)+"&endCity="+escape(endCity)+"&SearchFlg="+SearchFlg ;
		AJAXRequest(dataurl,true,"POST",data,SearchPath_CallBack1);
		loadBar(1);
	}
};
var startXY;
var endXY;
function SearchPath_CallBack1(response){ ////回应 自驾路线
	loadBar(0);
	response=response.trim();
	if(response == null || response == "" || response =="没有查到路线") {
		alert("没有查到路线!");
		return;
	}
 showConditionDis();
     showRez();
//	switchdiv(1)
	curLine = 0 ;
	temp = response.split('#');
	head = temp[0].trim();//文字描述
	var dotArr = temp[1].split(";");
	var coor = "" ;
	for(var i = 0 ; i <dotArr.length ; i++){
		coor +=dotArr[i]+",";
	}
	coor = coor.substring(0,coor.length -1) ;//分析结果线路坐标

	mulRes = null;	
	mulRes = new Array();
	
	
	var tmpSpecialNodeArray = new Array() ;// 存放起始特殊点
    startXY = dotArr[0].split(",");
	endXY = dotArr[dotArr.length-1].split(",");
	tmpSpecialNodeArray.push(new Node(startStop,startXY[0],startXY[1],0,0)); //起点
	tmpSpecialNodeArray.push(new Node(endStop,endXY[0],endXY[1],1,5)); //终点
	car = new Array();	
	car[0] = new IMSCarMove();
	car[0].setLineInfo(coor);
	car[0].drawLine(); 
	car[0].specialNodeInfoArray = tmpSpecialNodeArray;
	car[0].pntLocation(); 
	car[0].openSpecialNodeDiv();
	setPathRes(head,temp[2].trim(),coor);	     
}

var jwLen = 111000//经纬度坐标1度，约等于103133.845米。
//路径分析结果（用于右侧展现）
function setPathRes(resText,indexStr,coor){
	var temp = resText.split(";");
	var indexArr = indexStr.split("|");
	var showDiv = $("rezultframe");
	var showHtml = ""
	var pathIndex = ""
	
	if(showDiv != null){
		showHtml +='<DIV style="width:207px;">'
	    showHtml +='<TABLE style="PADDING-RIGHT: 0px; PADDING-LEFT: 0px; PADDING-BOTTOM: 0px; MARGIN: 0px; PADDING-TOP: 0px;BORDER-top: #c0c0c0 1px solid"" cellSpacing="1" cellPadding="0" width="98%" bgColor="#ffffff">';
	    showHtml +='<TBODY><TR bgColor="#e1e1e1"><TD height="24">驾车路线</TD><TD width="40px">&nbsp;&nbsp;&nbsp;里程</TD></TR></TBODY></TABLE>'
		showHtml +='<TABLE  class="routeResult"  style="MARGIN: 0px" cellSpacing="0" cellPadding="0" width="100%">' ;
	    showHtml +='<TR onmouseover="this.style.backgroundColor=\'#efefef\'" style="BACKGROUND-COLOR: #ffffff" onmouseout="this.style.backgroundColor=\'#ffffff\'">';
		showHtml +='<TD colSpan="3"><IMG src="images/qidian.gif" /> 起点：<font color = "red"><a onclick="jumpToCzPos('+startXY[0]+','+startXY[1]+');" href="#">'+startStop+'</a></font></TD></TR>'
		var roadLen = 0 ;
		for(var i = 0 ; i <temp.length ; i++){		
			var num = parseInt(indexArr[i])
			var nextNum = parseInt(indexArr[i+1])
			var d = parseInt((nextNum-num)/2)
			var dn = nextNum-num<1?num+d:num+1 ;
			var startX =car[0].HSLogicXArray[num];
			var startY =car[0].HSLogicYArray[num];
			var endX =car[0].HSLogicXArray[dn];
			var endY =car[0].HSLogicYArray[dn];
			var tem = temp[i].split("$");
		    var len = Math.round(tem[1]*jwLen) ;
		 	var lr = "" ;
		    roadLen +=len ;
		    if(len>1000)
		    	len = Math.round(len/1000) +"公里" ;
		    else
		    	len = len+'米' ;
		   
	    	if(i!=0){	    		
	    		var headNum = parseInt(indexArr[i-1])
	    		var d = parseInt((num -headNum)/2)
	    		var dh = num -headNum<2?num-d:num-2;
    			 var startX1 = car[0].HSLogicXArray[dh]
    			 var startY1 = car[0].HSLogicYArray[dh]
	   			 var lr =GetLeftOrRight(startX1,startY1,startX,startY,endX,endY);
	    	}
		    var direction = checkdirction(startX,startY,endX,endY) ;		    	
		    showHtml +='<TR onmouseover="this.style.backgroundColor=\'#efefef\'" style="BACKGROUND-COLOR: #ffffff" onclick=""onmouseout="this.style.backgroundColor=\'#ffffff\'">';
		    if(i==0)
		    	showHtml +='<TD>'+(i+1)+'．<SPAN class="gray2">沿</SPAN><B><a onclick="jumpToCzPos('+endX+','+endY+');" href="#">'+tem[0]+'</a></B><SPAN class="gray2">向</SPAN><B>'+direction+'</B><SPAN class="gray2">行驶</SPAN></TD>';
		   	else
		   		showHtml +='<TD>'+(i+1)+'．<B>'+lr+'</B><SPAN class="gray2">进入</SPAN><B><a onclick="jumpToCzPos('+endX+','+endY+');" href="#">'+tem[0]+'</a></B><SPAN class="gray2">向</SPAN><B>'+direction+'</B><SPAN class="gray2">行驶</SPAN></TD>';
		   		showHtml +='<TD align="right">'+len+'</TD><TD width="5px">&nbsp;&nbsp;</TD></TR>';
		    
		}
		if(roadLen>1000)
		    	roadLen = Math.round(roadLen/1000) +"公里" ;
		    else
		    	roadLen = roadLen+'米' ;
		var i = 0 ;
	    showHtml +='<TR onmouseover="this.style.backgroundColor=\'#efefef\'" onmouseout="this.style.backgroundColor=\'#ffffff\'">';
	    showHtml +='<TD colSpan="3"><IMG src="images/zhongdian.gif" /> 终点：<font color = "red"><a onclick="jumpToCzPos('+endXY[0]+','+endXY[1]+');" href="#">'+endStop+'</a></font>         共约'+roadLen+'</TD></TR>';
	    showHtml +='<TR onmouseover="this.style.backgroundColor=\'#efefef\'" onmouseout="this.style.backgroundColor=\'#ffffff\'">';
	    showHtml +='<TD style="PADDING-RIGHT: 20px" align="left" >'
	    showHtml +='<img style="CURSOR:hand" alt="开始播放" id="Btn_GO'+i+'" src="images/play.jpg" onclick=carmove('+i+',\"'+coor+'\")>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
	    showHtml +='<img style="CURSOR:hand" id="Btn_STOP'+i+'" alt="停止播放" src="images/stop.jpg" onclick="carstop('+i+')"></td>'
	    showHtml +=' <TD style="PADDING-RIGHT: 0px" align="right" colSpan="2" width="40px"></TD></TR> </TABLE></DIV>';
	    //showDiv.innerHTML = showHtml ;
	    $("rezultframe").innerHTML = showHtml;
	}
}
//(路径分析)判定左转还是右转
function GetLeftOrRight(sx1,sy1,sx2,sy2,ex,ey){
	var returnStr = "" ;
	 var startAngle = computeAngle(sx1,sy1,sx2,sy2)
	 var endAngle = computeAngle(sx1,sy1,ex,ey)
	 if(endAngle-startAngle>0&&endAngle-startAngle<180)
		returnStr = "右转"
	 else if(endAngle-startAngle==0)
	 	return Str = "直走" ;
	else 
		returnStr = "左转" ;
	return returnStr ;
}

//路径分析（搜索路径）回调函数
function SearchPath_CallBack(response){
	loadBar(0);
    if(response == null || response == ""|| response =="没有查到路线")  {
			alert("没有查到路线!");
			return;
	}
	if(car !=null){
	    for(var i = 0; i <car.length ; i++){   
	        if(car[i]!=null){ 
		        car[i].clearVar() 
		        if(car[i].traceTimer!=null)
		            clearInterval(car[i].traceTimer);
		    }
	    }
	    if(window.carmoveflg!=0)
		            car[0].stop()
	}
//	switchdiv(1);
 showConditionDis();
     showRez();
	var tableHtml = '<table cellSpacing=0 cellPadding=0 width="100%" border=1 borderColor="#99ccff"><tr><td width="20%" height="30"><div align="center">线路号</div></td><td width="80%"><div align="center">驾车线路</div></td></tr>';
    var k=0;
	curPage = 0;	
	var LocPnt = response.split("$");
	mulRes = null;	
	mulRes = new Array();
	car = new Array();	
	for(var i=0;i<LocPnt.length;i++) {
		mulRes[mulRes.length] = new BusRoute(LocPnt[i].split("|")[0],LocPnt[i].split("|")[1]);		
		tableHtml += '<tr><td width="20%" height="30"><div align="center">'+(i+1)+'</div></td>';
		var str = mulRes[mulRes.length-1].strRoute.split(";");
		var strTmp = "<table width='100%'>";
		var resStr = "" ;
		for(var j=0;j<str.length-1;j++) {
            var temp1= str[j].split(",") ;
            var temp2 = str[j+1].split(",") ;
            if(j==0){
                if(temp1[0]==temp2[1])	
                    resStr += str[j] + ";" + str[j+1]	;
                else 
                    resStr += str[j] + "$" + str[j+1]	;
            }
            else{
                if(temp1[1]==temp2[1])	
                    resStr +=  ";" + str[j+1]	;
                else 
                    resStr += "$" + str[j+1]	;
            }
		}
		var resArr =resStr.split("$") ;
		for(var j = 0 ; j < resArr.length ;j ++){
			strTmp += "<tr>";
			strTmp += "<td>";
			var temp = "" ;
			var num = 0 ;
			if(j==0){
					  temp = resArr[j].split(";") ;
					  for(var k = 0 ; k <temp.length ;k++){
					  	var temp1 = temp[k].split(",");
					  	if(k==0)
					  			num +=parseInt(temp1[1].substring(3,temp1[1].length-1)) ;
					  	else
					  			num += parseInt(temp1[2].substring(3,temp1[2].length-1))
					  }
					  var res  = temp[0].split(",") ;
					  var res1 = ""
					  if(j==resArr.length-1)
					    res1 = temp[temp.length-1].split(",")[3];
					  else
					     res1  = res[2] ;
					  strTmp += "第<font color='red'>"+(j*1+1)+"</font>步：" + "从"+startStop+"出发,"+res[0]+",前行约"+(num-1)+"米,"+res1;		  
				} else {
					  temp = resArr[j].split(";") ;
					  for(var k = 0 ; k <temp.length ;k++){
                           var temp1 = temp[k].split(",");
                           num += parseInt(temp1[2].substring(3,temp1[2].length-1))
					  }
					  var res  = temp[0].split(",") ;
					  var res1 = ""
					  if(j==resArr.length-1)
					    res1 = temp[temp.length-1].split(",")[3];
					  else
					     res1  = res[3] ;
					  strTmp += "第<font color='red'>"+(j*1+1)+"</font>步："+res[0]+","+res[1]+",前行约"+(num-1)+"米,"+res1;
				}
				
		}		
		strTmp += "</table>";
		var coor = mulRes[i].strPos;
		car[i] = new IMSCarMove();
	    car[i].setLineInfo(coor);

	    tableHtml += '<td width="80%"><div align="left">' + strTmp + '<img style="CURSOR:hand" alt="开始播放" id="Btn_GO' + i + '" src="images/play.jpg" onclick=carmove(' + i + ')>&nbsp;<img style="CURSOR:hand" id="Btn_STOP' + i + '" alt="停止播放" src="images/stop.jpg" onclick="top.carstop(' + i + ')"></div></td></tr>';
	}	debugger
	car[0].drawLine();                    
	
	tableHtml += '</table>';
	$("rezultframe").innerHTML = tableHtml
};
function BusRoute(strRoute,strPos){   
    this.strRoute = strRoute;
    this.strPos = strPos;
};	

///////////////////////////////////////////////////////////////////公交查询///////////////////////////////////////////////////////////////////////////////
 
var CarIndex = -1;  //用于标识Car数组的Index  
var m=map ;
var curLine = 0 ;
window.showNormalNodeFlag = false;       //显示普通点的标志    
//定义站点信息类
function Node(name,logicX,logicY,seq,type){ 
    this.name = name;  
    this.x = logicX;
    this.y = logicY;
    this.seq = seq;    //标识车站的序列号，同时也用于标识div层的ID,起点为0
    this.type = type; //0 起点；1 乘车点(标识起点有步行的情况)；2 普通点(线路上的站点)；3 步行点;4 换乘点;5 终点 
};
function SearchBusWay(){
    var start = $("bs1").value
    var end = $("bs2").value
    if(start=="")
        alert("起点名称没填！");
    else if(end=="")
        alert("终点名称没填！");
    else if(thisObj.isCarMove)
        alert("小车正在运行状态，请先停止小车移动");
    else {
        var dataurl = "Maps.ashx?";
        var data = "_method=GetBusWay"+"&staPos="+escape(start)+"&endPos="+escape(end);
     AJAXRequest(dataurl,true,"POST",data,SearchBusWay_CallBack);
     loadBar(1);
    }
};
function SearchBusWay_CallBack(response){
	 loadBar(0);
    if (response == null || response == "")	{		
		alert("没有线路!")	;	
		return;
	}
	if(car !=null){
	    for(var i = 0; i <car.length ; i++){   
	        if(car[i]!=null){ 
		        car[i].clearVar() 
		        if(car[i].traceTimer!=null)
		            clearInterval(car[i].traceTimer);
		    }
	    }
	    if(window.carmoveflg!=0)
		            car[0].stop()
	}
//	switchdiv(1);
	showConditionDis();
     showRez();//显示查询结果
	car = null ;
	car = new Array();
    var busWayAnly = new Array();   
    var divHtml ='' ;
    if($("busLineDiv"))
 	    $("busLineDiv").innerHTML = "";
     if(typeof(response) != "string") return;  
    var resDiv = $("rezultframe"); 
    if(response.indexOf('$') != -1)
       busWayAnly = response.split('$');  //方案数组
    else
		busWayAnly[0] = response;
	for(var i=0;i<busWayAnly.length;i++) {
    	car[i] = new IMSCarMove(); 
		var stopInfo = "";
		var busLin	= "";
		var busStopName	= "";
		var wayRecom	= 0;
		var oneBusWay	= busWayAnly[i].split("#");//一个方案中的所有公交路线
		var dtHtml = '';      //dt元素
		var ddHtml = '';      //dd元素
		var length = 0;       //线路总长
		var hcTimes = 0;      //换乘次数
		var curtail = '';     //简略的换乘方案
		var walkLength = 0;   //行走距离
		var busStopsCount = 0;//一个换乘方案的车站站点计数
	    var tmpSpecialNodeArray = new Array();//暂时存放特殊站点的Array，结构为Node
	    var tmpNormalNodeArray  = new Array();//暂时存放普通站点的Array，结构为Node
	    var stopsSeq = -1;              //标识一个乘车方案的车站站点序列,0为起点序列
	    var lstStopName = '';          //记录最后一个站点的名称
	    var lstStopX = '';
	    var lstStopY = '';
        var isStartWalked = -1;          //标识是否在起点车站步行
        for(var j=0;j<oneBusWay.length-1;j++) {
			var oneBusName	= oneBusWay[j].split("|")[0]; //一条公交路线的名称
			var oneStopInfo	= oneBusWay[j].split("|")[1].split("@")[0];//一条公交路线的所有车站名称及坐标数组
			var tmpStopInfo = oneStopInfo.split(",");//存放站点名称坐标数组
			var oneBusLin		= oneBusWay[j].split("|")[1].split("@")[1];//一条公交线路的坐标
            var oneStartStop	= tmpStopInfo[0];
			var oneStartStopX   = tmpStopInfo[1];
			var oneStartStopY   = tmpStopInfo[2];
			var oneLastStop	 = tmpStopInfo[tmpStopInfo.length-3];//一条线路终止站点
			var oneLastStopX = tmpStopInfo[tmpStopInfo.length-2];
			var oneLastStopY = tmpStopInfo[tmpStopInfo.length-1];	 	
			stopInfo	+= oneStopInfo + "@";//一套方案中的所有车站信息
			wayRecom	= (oneStopInfo.split(",").length/3) - 1;//一条线路经过的车站数
			busLin += oneBusLin + ",";
			var fx = checkdirction(oneStartStopX,oneStartStopY,oneLastStopX,oneLastStopY);
			if(oneBusName == "" || oneBusName == undefined) {
			     if(j==0) {   //起点车站需要步行
			  	    isStartWalked = 1;
			  	    stopsSeq++;
			  	    tmpSpecialNodeArray.push(new Node(tmpStopInfo[0],tmpStopInfo[1],tmpStopInfo[2],stopsSeq,0)); //起点车站需要步行 只标识其为起点
				    walkLength = getLength(oneBusLin).toFixed(5);
				    ddHtml += '<img style="float: left; width: 24px; height: 24px" height="24" src="images/walk.gif" width="23">';
				    ddHtml += '<p><a onclick="jumpToCzPos('+oneStartStopX+','+oneStartStopY+');" href="#">'+oneStartStop+'</a>出发往<font color="red">'+fx+'</font>方向行走约<font color="red">'+walkLength+'</font>米';
				    if(oneStartStop==oneLastStop)
				        ddHtml += '至附近同名站点<a onclick="jumpToCzPos('+oneLastStopX+','+oneLastStopY+');" href="#">'+oneLastStop+'</a></p>';
                    else
				        ddHtml += '至<a onclick="jumpToCzPos('+oneLastStopX+','+oneLastStopY+');" href="#">'+oneLastStop+'</a></p>';
			     } else if (j == oneBusWay.length-2)  { //终点车站需要步行
                     stopsSeq++;
                     tmpSpecialNodeArray.push(new Node(tmpStopInfo[0],tmpStopInfo[1],tmpStopInfo[2],stopsSeq,3));			
                     walkLength = getLength(oneBusLin).toFixed(5);
                     ddHtml += '<img style="float: left; width: 24px; height: 24px" height="24" src="images/walk.gif" width="23">';
				     ddHtml += '往'+fx+'方向行走约<font color="red">'+walkLength+'</font>米至<a onclick="jumpToCzPos('+oneLastStopX+','+oneLastStopY+');" href="#">'+oneLastStop+'</a></p>';
			     }else  { //换乘车站间需要步行
                     stopsSeq++;
                     tmpSpecialNodeArray.push(new Node(tmpStopInfo[0],tmpStopInfo[1],tmpStopInfo[2],stopsSeq,3));              
				     walkLength = getLength(oneBusLin).toFixed(5);
				     ddHtml += '<img style="float: left; width: 24px; height: 24px" height="24" src="images/walk.gif" width="23">';
				     if(oneStartStop==oneLastStop)
				        ddHtml += '<p>从<a onclick="jumpToCzPos('+oneStartStopX+','+oneStartStopY+');" href="#">'+oneStartStop+'</a>出发往'+fx+'方向行走约<font color="red">'+walkLength+'</font>米至附近同名站点<a onclick="jumpToCzPos('+oneLastStopX+','+oneLastStopY+');" href="#">'+oneLastStop+'</a></p>';
			         else
			            ddHtml += '<p>从<a onclick="jumpToCzPos('+oneStartStopX+','+oneStartStopY+');" href="#">'+oneStartStop+'</a>出发往'+fx+'方向行走约<font color="red">'+walkLength+'</font>米至<a onclick="jumpToCzPos('+oneLastStopX+','+oneLastStopY+');" href="#">'+oneLastStop+'</a></p>';
			     }
			 }else if(j==0){
			     hcTimes++;
			     curtail += oneBusName.split('(')[0]+"路";
			     ddHtml += '<img style="float: left; width: 24px; height: 24px" height="24" src="images/qidian.gif" width="23">';
		         stopsSeq++;
		         tmpSpecialNodeArray.push(new Node(tmpStopInfo[0],tmpStopInfo[1],tmpStopInfo[2],stopsSeq,0)); //标识为起点 
			     ddHtml += '<p><a onclick="jumpToCzPos('+oneStartStopX+','+oneStartStopY+');" href="#">'+oneStartStop+'</a> 乘 <font color=blue>' + oneBusName + '</font> 经 <font color=red>' + wayRecom + '</font> 个站点';
		         for(var k=3;k<tmpStopInfo.length-3;k+=3){
                    stopsSeq++;
                    tmpNormalNodeArray.push(new Node(tmpStopInfo[k],tmpStopInfo[k+1],tmpStopInfo[k+2],stopsSeq,2));
		         }
			     ddHtml += ' 在 <a onclick="jumpToCzPos('+oneLastStopX+','+oneLastStopY+');" href="#">' + oneLastStop + '</a> 下车</p>';		
			 } else {
		         hcTimes++;	
			     if (isStartWalked == 1) 
				 {
					 isStartWalked = -1;
					 stopsSeq++;
			         tmpSpecialNodeArray.push(new Node(tmpStopInfo[0],tmpStopInfo[1],tmpStopInfo[2],stopsSeq,1)); //起点车站需要步行 只标识其为乘车点
					 ddHtml += '<img style="float: left; width: 21px; height: 16px" height="16" src="images/icon_9.gif" width="21">';
					 ddHtml += '<p> 乘 <font color=blue>'+oneBusName+'</font> 经 <font color=red>' + wayRecom + '</font> 个站点';
			         for(var k=3;k<tmpStopInfo.length-3;k+=3)  {
		                stopsSeq++;
                        tmpNormalNodeArray.push(new Node(tmpStopInfo[k],tmpStopInfo[k+1],tmpStopInfo[k+2],stopsSeq,2));
		             }
					 ddHtml += ' 在 <a onclick="jumpToCzPos('+oneLastStopX+','+oneLastStopY+');" href="#">' + oneLastStop + '</a> 下车</p>';
					 curtail += oneBusName.split('(')[0]+"路";
				 }else  {                             //换乘
					 ddHtml += '<img style="float: left; width: 16px; height: 20px" height="20" src="images/shift.gif" width="16">';
					 stopsSeq++;
			         tmpSpecialNodeArray.push(new Node(tmpStopInfo[0],tmpStopInfo[1],tmpStopInfo[2],stopsSeq,4)); //标识为换乘点 
					 ddHtml += '<p> 换乘 <font color=blue>'+oneBusName+'</font> 经 <font color=red>' + wayRecom + '</font> 个站点';
			         for(var k=3;k<tmpStopInfo.length-3;k+=3) {
                         stopsSeq++;
                         tmpNormalNodeArray.push(new Node(tmpStopInfo[k],tmpStopInfo[k+1],tmpStopInfo[k+2],stopsSeq,2));                        
			          }
				   ddHtml += ' 在 <a onclick="jumpToCzPos('+oneLastStopX+','+oneLastStopY+');" href="#">' + oneLastStop + '</a> 下车</p>';
				   curtail += ' 转 '+ oneBusName.split('(')[0]+"路";
				 }									
			 }
			 var tmpIndex = tmpStopInfo.length-1;
			 lstStopName = tmpStopInfo[tmpIndex-2];
			 lstStopX = tmpStopInfo[tmpIndex-1];
			 lstStopY = tmpStopInfo[tmpIndex];
		 }
		 stopsSeq++;		
         tmpSpecialNodeArray.push(new Node(lstStopName,lstStopX,lstStopY,stopsSeq,5)); //标识终点车站
         car[i].specialNodeInfoArray = tmpSpecialNodeArray;
         car[i].normalNodeInfoArray = tmpNormalNodeArray;

         //设置待绘制的线信息-坐标
         car[i].setLineInfo(busLin.substring(0, busLin.length-1));           
		 ddHtml = '<div id="'+i+'_busresult" style="margin-left: 11px;margin-bottom: 7px;display:none"><p>&nbsp;&nbsp;&nbsp;全程约 <font color=red>'+(getLength(busLin)/1000).toFixed(5)+'</font> 公里</p><br/><br/>'+ddHtml;
		 if (hcTimes == 1) {
			 dtHtml = '<dt><table><tr><td>'+(i+1)+'.<a id=line'+i+' href="javascript:showDetail('+busWayAnly.length+','+i+');">'+curtail+'（显示）</a></td><td align = right><span style=""><font color=red text-align=right>[直达]</font></span></td></tr></table>'+ddHtml;
		 }
		 else
			 dtHtml = '<dt>'+(i+1)+'.<a id=line'+i+' href="javascript:showDetail('+busWayAnly.length+','+i+');">'+curtail+'（显示）</a><span><font color=red>[换乘'+(hcTimes-1)+'次]</font></span>'+ddHtml;
		 dtHtml  += '<p style="border-top: #ccc 1px solid; width: 180px; margin-left: 2px;text-align: center">';
		 dtHtml  += '<img style="CURSOR:hand" alt="开始播放" id="Btn_GO'+i+'" src="images/play.jpg" onclick=carmove('+i+')>&nbsp;<img style="CURSOR:hand" id="Btn_STOP'+i+'" alt="停止播放" src="images/stop.jpg" onclick="carstop('+i+')">';
		 dtHtml  += '&nbsp;<input id="'+i+'_ck" type="checkbox" onclick="checkchange('+i+')"/><font color=blue>显示所有站点</font></p></div>';
		 divHtml += dtHtml;
	}
	divHtml	+= '</dl>'; 
	resDiv.innerHTML = divHtml; 
    //默认显示第一条解决方案
    curLine = 0 ;
    var o = document.getElementById(curLine+"_busresult");
	if(o!=null)	
	{
		o.style.display = "block";
		car[0].openSpecialNodeDiv();
		car[0].openNormalNodeDiv();

        //客户端绘制线
		car[0].drawLine();
		window.CarIndex=0;
		changeLineStatue(curLine) ;

	}		
};
function checkdirction(sx,sy,ex,ey){
    var dir = "";
    if(ex>sx)
        dir+="东";
    if(ex<sx)
        dir+="西";
    if(ey>sy)
        dir+="北";
    if(ey<sy)
        dir+="南";
    return dir;    
};

function checkchange(i){
    var chk = $(i+"_ck");
    if(chk==null)
        return;
    if(chk.checked == true) {
        window.showNormalNodeFlag = true; 
        car[i].openNormalNodeDiv(); 
    } else {
        window.showNormalNodeFlag = false; 
        car[i].closeNormalNodeDiv();
    } 
};
function changeLineStatue(id){
    var line = $('line'+id) ;
    var str = line.innerHTML ;
    var statue= str.substring(str.length-3,str.length-1).trim();
    var tempL = str.substring(0,str.length-3) ;
    if(statue =="隐藏"){
        line.innerHTML = tempL +"显示）" ;
         curLine = -1 ;
    }
    else{
        line.innerHTML = tempL +"隐藏）" ;
        curLine = id ;
    }
}
//只显示一个Detail(不同换乘方案之间切换)
function showDetail(total,id) {
    checkchange(id);
    if(id!=curLine&&curLine!=-1)
        changeLineStatue(curLine) ;
    changeLineStatue(id) ;
    for(var i=0; i<total; i++) {
	    if(i!=id) {
	        var o = document.getElementById(i+'_busresult');
        	if(o.style.display == "block") {
				o.style.display = "none";
				window.CarIndex = -1;
				if(window.carmoveflg != 0)
				    carstop(i);
                   car[id].clearVar();
			}
	    }
	}	
	var o = document.getElementById(id+'_busresult');
	if(o!=null)	{
		if(o.style.display == "none") {
			o.style.display = "block";
			car[id].drawLine();
			car[id].openSpecialNodeDiv();
			car[id].openNormalNodeDiv();
			window.CarIndex=id;
		} else {
	    	o.style.display = "none";
	    	window.CarIndex = -1;
			car[id].clearVar();
		}
	}
};
//跳转到车站在地图中的位置
function jumpToCzPos(x,y) {
    map.pntLocation(x,y);    
};
 //str线路坐标串，以逗号隔开(x1,y1,x2,y2,x3,y3...........)
function getLength(str) {//计算线路全程长度
	var length = 0;
	var coordinateXY = str.split(',');
	for(var k=0; k<coordinateXY.length; k+=2) {
		if (k+3 <coordinateXY.length) {
			var x1 = coordinateXY[k];
			var y1 = coordinateXY[k+1];
			var x2 = coordinateXY[k+2];
			var y2 = coordinateXY[k+3];
			length += Math.sqrt(Math.pow(x2-x1,2) + Math.pow(y2-y1,2));
		}		
	}
	return length;
};
function carmove(i) {   
    if(window.carmoveflg == 0) {
        iroute = i;
        $("Btn_GO"+i).src='images/pause.jpg';
	    $("Btn_GO"+i).alt="暂停播放";
	    car[i].move(1);
	    thisObj.isCarMove = true ;
	} else if(window.carmoveflg == 1) {
        if(iroute != i) return;  
        document.getElementById("Btn_GO"+i).src='images/play.jpg';
	    document.getElementById("Btn_GO"+i).alt="开始播放";		
	    car[i].pause();
	    thisObj.isCarMove = true ;
	} else if(window.carmoveflg == 2) {
        if(iroute != i) return;  
        document.getElementById("Btn_GO"+i).src='images/pause.jpg';
	    document.getElementById("Btn_GO"+i).alt="暂停播放";	    
	    car[i].move(1);
	    thisObj.isCarMove = false ;
	}       
};
function ReDrawTraceLineAndNode() {
    if(window.CarIndex > -1)
        car[window.CarIndex].RePainting(car[window.CarIndex]);
};

function carstop(i) {  
    if(iroute != i) return; 
    car[i].stop();
    document.getElementById("Btn_GO"+i).src='images/play.jpg';
	document.getElementById("Btn_GO"+i).alt="开始播放";	
	thisObj.isCarMove = false ;
};

